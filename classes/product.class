<?php
    class Product{
        private $conn;

        public function __construct($db) {
            $this->conn = $db;
        }
        public function index($page, $recordsPerPage) {
            // Calculate the offset for the query
            $offset = ($page - 1) * $recordsPerPage;
            $sqlCount = "SELECT COUNT(*) as total FROM products";
            $stmtCount = $this->conn->prepare($sqlCount);
            try {
                $stmtCount->execute();
                $totalRecords = $stmtCount->fetch(PDO::FETCH_ASSOC)['total'];
            } catch (PDOException $e) {
                return ['status' => 'error', 'message' => 'Database error: ' . $e->getMessage()];
            }
    
            // Calculate total pages
            $totalPages = ceil($totalRecords / $recordsPerPage);
    
            // Query to get the records for the current page
            $sql = "SELECT * FROM products LIMIT :limit OFFSET :offset";
            $stmt = $this->conn->prepare($sql);
            $stmt->bindParam(':limit', $recordsPerPage, PDO::PARAM_INT);
            $stmt->bindParam(':offset', $offset, PDO::PARAM_INT);
    
            try {
                $stmt->execute();
                $categories = $stmt->fetchAll(PDO::FETCH_ASSOC);
                return [
                    'status' => 'success',
                    'data' => $categories,
                    'currentPage' => $page,
                    'totalPages' => $totalPages,
                    'recordsPerPage' => $recordsPerPage,
                    'totalRecords' => $totalRecords
                ];
            } catch (PDOException $e) {
                return ['status' => 'error', 'message' => 'Database error: ' . $e->getMessage()];
            }
        }
        public function getAllProduct(){
            $sql = "SELECT * FROM products";
            $stmt = $this->conn->prepare($sql);
            $stmt->execute();
            $products = $stmt->fetchAll(PDO::FETCH_ASSOC);
            return ['status'=>'success', 'data'=>$products];
        }

        public function create($request){
            $category_id = $request['categoryname'];
            $name = $request['name'];
            $image = $request['image'];
            $price = $request['price'];
            $amount = $request['amount'];
            $sql = "INSERT INTO products(name, image,price, amount, category_id) VALUES (:name, :image, :price, :amount, :category_id)";
            try {
                $stmt = $this->conn->prepare($sql);
                $result = $stmt->execute(['name' => $name, 'image' => $image, 'price' =>$price,'amount' => $amount, 'category_id'=>$category_id]);
                if ($result) {
                    return ['status'=>'success'];
                } else {
                    return ['status'=>'failed'];
                }
            } catch (PDOException $e) {
                error_log('Database error: ' . $e->getMessage());
                return ['status'=>'failed'];
            }
        }
        public function checkProduct($request) {
            $categoryname = trim($request['categoryname']);
            $name = trim($request['name']);
            $sql = "SELECT * FROM products WHERE category_id = :categoryname and name = :name";
            
            try {
                $stmt = $this->conn->prepare($sql);
                $stmt->bindParam(':categoryname', $categoryname, PDO::PARAM_STR);
                $stmt->bindParam(':name', $name, PDO::PARAM_STR);
                $stmt->execute();
                $result = $stmt->fetch(PDO::FETCH_ASSOC);

                return $result;
            } catch (PDOException $e) {
                error_log('Database error: ' . $e->getMessage());
                return 'error';
            }
        }
        public function updateProduct($request) {
            $sql = 'UPDATE products SET name = :name, image = :image, price = :price, amount = :amount, category_id= :categoryid WHERE id = :id';
        
            // Prepare the statement
            $stmt = $this->conn->prepare($sql);
        
            // Bind parameters to prevent SQL injection
            $stmt->bindParam(':name', $request['name'], PDO::PARAM_STR);
            $stmt->bindParam(':image', $request['image'], PDO::PARAM_STR);
            $stmt->bindParam(':price', $request['price'], PDO::PARAM_INT);
            $stmt->bindParam(':amount', $request['amount'], PDO::PARAM_INT);
            $stmt->bindParam(':categoryid', $request['categoryid'], PDO::PARAM_INT);
            $stmt->bindParam(':id', $request['id'], PDO::PARAM_INT);
            $stmt->execute();
            if($stmt->rowCount() > 0){
                return ['status'=>'success'];
            }else{
                return ['status'=>'failed'];
            }
        }
        public function deleteProduct($request) {
            $sql = 'DELETE FROM products WHERE id = :productid';
            $stmt = $this->conn->prepare($sql);
            $stmt->bindParam(':productid', $request['productid'], PDO::PARAM_INT);
            $stmt->execute();
            return $stmt->rowCount();
        }

    }
?>